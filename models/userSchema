// const mongoose = require('mongoose');
// const bcrypt = require('bcryptjs');

// // -------------------- User Schema --------------------
// const userSchema = new mongoose.Schema({
//   name: { type: String, trim: true },
//   email: { type: String, required: true, unique: true, lowercase: true, trim: true },
//   password: { type: String }, // Ù…Ø®Ø²Ù† ÙƒÙ‡Ø§Ø´
//   role: { type: String, enum: ['adminprincipal', 'agence', 'announceur', 'client'], default: 'client' },
//   phones: [{ type: String }],
//   address: { type: String },
//   //pour admin
//   adminCode: { type: String }, // ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†
//   // pour agence
//   vehicules: [{ type: mongoose.Schema.Types.ObjectId, ref: 'vehicules' }],
//   // pour announceur
//   annonces: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Annonce' }],
//   // pour client
//   reservations: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Reservation' }],
//   image: { type: String, default: 'default-user.png' },
//   status: { type: String, enum: ['active','inactive','banned'], default: 'inactive' }
// }, { timestamps: true });//yjin wakth el model hadha tsna3 wala sartlo update




// userSchema.post('save', function(doc, next) {
//     console.log('New user created: ', doc);
//     next();
// });

// const User = mongoose.model('User', userSchema);
// module.exports = User;




const mongoose = require('mongoose');
 const bcrypt = require('bcryptjs');

// -------------------- User Schema --------------------
const userSchema = new mongoose.Schema({
  nom: { type: String, trim: true },
    prenom: { type: String, trim: true },

  
  email: { 
    type: String, 
    required: true, 
    unique: true, 
    lowercase: true, 
    trim: true, 
    match: [/@/, 'Please fill a valid email address'] // validation Ù…Ø«Ù„ Ø§Ù„Ø£ÙˆÙ„
  },
  
  password: { 
    type: String, 
    required: true,
    minlength: 6,
    match: [
      /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}$/, 
      'Password must contain at least one uppercase letter, one lowercase letter, and one digit.'
    ]
  },

  role: { 
    type: String, 
    enum: ['adminprincipal', 'agence', 'announceur', 'client'], 
    default: 'client' 
  },
  // ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ù„Ù…Ø§ ÙŠÙƒÙ…Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ)
  phones: [{ type: String }],
  address: { type: String },
  description: { type: String },
  // pour admin
  adminCode: { type: String },

  // pour agence
  vehicules: [{ type: mongoose.Schema.Types.ObjectId, ref: 'vehicules' }],

  // pour annonceur
  annonces: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Annonce' }],

  // pour client
  reservations: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Reservation' }],

  image: { type: String, default: 'default-user.png' },
  // status: { type: String, enum: ['active','inactive','banned'], default: 'inactive' }

}, { timestamps: true });

userSchema.pre('save', async function (next) {
  // ÙÙ‚Ø· Ù†Ø¹Ù…Ù„ hash Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ù…Ø¹Ø¯Ù‘Ù„Ø©
  if (!this.isModified('password')) return next();

  try {
    const salt = await bcrypt.genSalt(10); // ØªÙˆÙ„ÙŠØ¯ salt
    this.password = await bcrypt.hash(this.password, salt); // ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
    next();
  } catch (err) {
    next(err);
  }
});

// ğŸ”¸ Ø¯Ø§Ù„Ø© Ù„Ù…Ù‚Ø§Ø±Ù†Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
userSchema.methods.comparePassword = async function (enteredPassword) {
  return await bcrypt.compare(enteredPassword, this.password);
};







// Post-save hook
// userSchema.post('save', function(doc, next) {
//     console.log('New user created: ', doc);
//     next();
// });

const User = mongoose.model('User', userSchema);
module.exports = User;
